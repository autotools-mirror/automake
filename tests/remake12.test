#! /bin/sh
# Copyright (C) 2010 Free Software Foundation, Inc.
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

# Test basic remake rules for Makefiles with non-default names
# and/or with multiple sources.

required=GNUmake
. ./defs || Exit 1

set -e

magic1=::MagicStringOne::
magic2=__MagicStringTwo__
magic3=%%MagicStringThree%%

cat > configure.in <<END
AC_INIT([$me], [1.0])
AM_INIT_AUTOMAKE
AC_CONFIG_FILES([zardoz])
AC_CONFIG_LINKS([Makefile:Makefile])
AC_OUTPUT
END

cat > zardoz.am <<END
EXTRA_DIST = Makefile
#H: $magic1
END

cat > Makefile <<END
include zardoz
nil:
.PHONY: nil
END

$ACLOCAL
$AUTOCONF
$AUTOMAKE

./configure

$MAKE nil
grep '^#H:' zardoz.in # for debugging
$FGREP $magic1 zardoz
$FGREP $magic1 zardoz.in
$MAKE distcheck
$MAKE distclean # this shouldn't remove Makefile
ls -l
test -f Makefile

./configure

$sleep
sed "s/%MAGIC3%/$magic3/" >> Makefile <<'END'
my-check:
	ls -l . $(srcdir) ;: for debugging
	test -f $(srcdir)/quux.am
	test -f $(srcdir)/quux.in
	test -f $(srcdir)/bot.in
	test -f $(srcdir)/top.in
	test ! -r $(srcdir)/zardoz.am
	test ! -r $(srcdir)/zardoz.in
	grep FOO zardoz ;: for debugging
	test x'$(FOO)' = x'%MAGIC3%'
test:
	ls -l ;: for debugging
	test x'$(FOO)' = x'dummy'
.PHONY: test my-check
END
sed "s/^#H:.*/#H: $magic2/" zardoz.am > t
cat >> t <<'END'
# used by "make distcheck" below
check-local: my-check
END
mv -f t zardoz.am
cat zardoz.am # for debugging
$MAKE nil
$FGREP my-check zardoz # sanity check
$FGREP $magic1 zardoz zardoz.in && Exit 1
$FGREP $magic2 zardoz
$FGREP $magic2 zardoz.in

./configure

$sleep
sed 's/^\(AC_CONFIG_FILES\)(.*/\1([zardoz:top.in:quux.in:bot.in])/' \
  <configure.in >t
mv -f t configure.in
cat configure.in # for debugging
sed '/^#H:/d' zardoz.am > quux.am
echo 'FOO = dummy' >> quux.am
echo 'BAR = $(BAZ)' > top.in
echo "BAZ = $magic3" > bot.in
$MAKE test
$FGREP my-check zardoz # sanity check
$FGREP $magic3 quux.in && Exit 1
$FGREP $magic3 zardoz
$FGREP $magic1 zardoz && Exit 1
$FGREP $magic2 zardoz && Exit 1
# After the remake above, the files `zardoz.am' and `zardoz.in'
# should be no more needed
echo 'endif' > zardoz.am # put in syntax error
$MAKE test
rm -f zardoz.in zardoz.am # get rid of them
$MAKE test

echo 'FOO = $(BAR)' >> quux.am
$MAKE distcheck

:
